name: Check ZEturf Inventory

on:
  push:
    paths:
      - 'resultats-et-rapports/**'
  workflow_dispatch:
    inputs:
      date:
        description: "Scanner uniquement cette date (YYYY-MM-DD)"
        required: false
        default: ""

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write  # n√©cessaire pour commit le dossier missing/

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install beautifulsoup4 lxml

      - name: Run checker
        run: |
          date_input="${{ github.event.inputs.date }}"
          if [ -n "$date_input" ]; then
            python check_inventory.py --date "$date_input"
          else
            python check_inventory.py
          fi

      - name: Upload reports as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: missing-reports
          path: missing/

      - name: Commit missing folder (if changes)
        if: always()
        run: |
          if [[ -n "$(git status --porcelain missing)" ]]; then
            git config user.name "GitHub Actions Bot"
            git config user.email "actions@github.com"
            git add missing
            git commit -m "chore(check): update missing list"
            git push
          else
            echo "No changes in missing/"
          fi
