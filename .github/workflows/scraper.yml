name: ZEturf Scraper (Matrix)

on:
  workflow_dispatch:
    inputs:
      start_year:
        description: 'AnnÃ©e de dÃ©part'
        required: false
        default: '2005'
      end_year:
        description: 'AnnÃ©e de fin'
        required: false
        default: '2025'
      force_rescrape:
        description: 'Force rescrape (ignorer fichiers existants)'
        required: false
        default: 'false'

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      years: ${{ steps.set-matrix.outputs.years }}
    steps:
      - name: Generate year matrix
        id: set-matrix
        run: |
          START=${{ github.event.inputs.start_year || '2005' }}
          END=${{ github.event.inputs.end_year || '2025' }}
          
          YEARS="["
          for ((year=START; year<=END; year++)); do
            if [ $year -ne $START ]; then
              YEARS+=","
            fi
            YEARS+="\"$year\""
          done
          YEARS+="]"
          
          echo "years=$YEARS" >> $GITHUB_OUTPUT
          echo "âœ“ Generated years: $YEARS"

  scrape:
    needs: generate-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 90  # 1h30 max par annÃ©e (largement suffisant)
    
    strategy:
      max-parallel: 2  # 2 annÃ©es en parallÃ¨le (pour Ã©viter conflits Git)
      fail-fast: false
      matrix:
        year: ${{ fromJson(needs.generate-matrix.outputs.years) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          # Ensure we're on main branch
          ref: main
      
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git config pull.rebase true
      
      - name: Pull latest changes
        run: |
          git pull origin main || echo "Already up to date"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install aiohttp beautifulsoup4 lxml
      
      - name: Check existing data for year ${{ matrix.year }}
        run: |
          if [ -d "resultats-et-rapports/${{ matrix.year }}" ]; then
            FILE_COUNT=$(find resultats-et-rapports/${{ matrix.year }} -type f -name "*.html" | wc -l)
            echo "ğŸ“Š Fichiers existants pour ${{ matrix.year }}: $FILE_COUNT"
          else
            echo "ğŸ“Š Aucun fichier existant pour ${{ matrix.year }}"
          fi
      
      - name: Run scraper for year ${{ matrix.year }}
        env:
          SCRAPE_YEAR: ${{ matrix.year }}
        run: |
          echo "ğŸš€ DÃ©marrage du scraping pour l'annÃ©e ${{ matrix.year }}"
          python scraper.py
        continue-on-error: false
      
      - name: Verify data was created
        run: |
          if [ -d "resultats-et-rapports/${{ matrix.year }}" ]; then
            FILE_COUNT=$(find resultats-et-rapports/${{ matrix.year }} -type f -name "*.html" | wc -l)
            echo "âœ… Total fichiers pour ${{ matrix.year }}: $FILE_COUNT"
            
            # Show directory structure
            echo "ğŸ“ Structure:"
            ls -lh resultats-et-rapports/${{ matrix.year }}/ 2>/dev/null || echo "Dossier vide"
          else
            echo "âš ï¸ Aucun dossier crÃ©Ã© pour ${{ matrix.year }}"
          fi
      
      - name: Status summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RÃ©sumÃ© pour l'annÃ©e ${{ matrix.year }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -d "resultats-et-rapports/${{ matrix.year }}" ]; then
            echo "âœ… AnnÃ©e ${{ matrix.year }} traitÃ©e avec succÃ¨s"
          else
            echo "âŒ Ã‰chec du traitement de l'annÃ©e ${{ matrix.year }}"
            exit 1
          fi
          
          # Show last commit
          echo ""
          echo "ğŸ“ Dernier commit:"
          git log -1 --oneline || echo "Aucun commit"
