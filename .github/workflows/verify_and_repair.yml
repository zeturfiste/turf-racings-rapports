name: Verify & Repair ZEturf Data

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  verify-repair-group:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6h max GitHub

    strategy:
      fail-fast: false
      max-parallel: 7
      matrix:
        group: [g1, g2, g3, g4, g5, g6, g7]
        include:
          - group: g1
            years: "2005 2006 2007"
          - group: g2
            years: "2008 2009 2010"
          - group: g3
            years: "2011 2012 2013"
          - group: g4
            years: "2014 2015 2016"
          - group: g5
            years: "2017 2018 2019"
          - group: g6
            years: "2020 2021 2022"
          - group: g7
            years: "2023 2024 2025"

    steps:
      # 1) √âtat disque + nettoyage agressif AVANT clonage
      - name: "üìä Disk usage BEFORE cleanup"
        run: |
          echo "=== df -h (global) ==="
          df -h
          echo ""
          echo "=== Top 20 plus gros dossiers (racine) ==="
          sudo du -xhd1 / | sort -h | tail -n 20 || true

      - name: "üßπ Aggressive cleanup BEFORE clone"
        run: |
          echo "=== df -h AVANT CLEANUP ==="
          df -h

          echo ""
          echo "üßπ Suppression des gros SDK/runtimes inutiles..."
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf "$ANDROID_HOME" || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /opt/hostedtoolcache || true

          echo ""
          echo "üßπ Docker / caches / temporaires..."
          docker system prune -af --volumes 2>/dev/null || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/* 2>/dev/null || true
          pip cache purge 2>/dev/null || true
          rm -rf ~/.cache ~/.npm ~/.yarn 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo journalctl --vacuum-time=1s 2>/dev/null || true
          sudo rm -rf /var/log/* 2>/dev/null || true

          echo ""
          echo "=== df -h APR√àS CLEANUP ==="
          df -h

      # 2) Sparse clone : script + ann√©es du groupe
      - name: "üì• Sparse clone for group ${{ matrix.group }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          YEARS="${{ matrix.years }}"
          BRANCH="${{ github.ref_name }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="main"
          fi

          echo "Groupe: ${{ matrix.group }} - Ann√©es: $YEARS"
          echo "Branche: $BRANCH"

          git clone --filter=blob:none --no-checkout --sparse \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" .

          git sparse-checkout init --no-cone

          PATTERNS="verify_and_repair.py"
          for Y in $YEARS; do
            PATTERNS="$PATTERNS resultats-et-rapports/${Y}"
          done

          echo "Sparse-checkout patterns: $PATTERNS"
          git sparse-checkout set $PATTERNS

          git checkout "$BRANCH"

          echo ""
          echo "=== df -h APR√àS CLONE (groupe ${{ matrix.group }}) ==="
          df -h
          echo ""
          echo "=== Taille des donn√©es pour ce groupe ==="
          for Y in $YEARS; do
            if [ -d "resultats-et-rapports/${Y}" ]; then
              du -sh "resultats-et-rapports/${Y}" || true
            else
              echo "Pas de dossier resultats-et-rapports/${Y}"
            fi
          done

      # 3) Setup Python + deps
      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "üì¶ Install dependencies"
        run: |
          pip install --no-cache-dir requests beautifulsoup4 lxml
          pip cache purge 2>/dev/null || true

      # 4) Verify + repair pour les 3 ann√©es du groupe
      - name: "‚úÖ Verify & repair years ${{ matrix.years }}"
        run: |
          set -e
          YEARS="${{ matrix.years }}"
          GLOBAL_EXIT=0

          for YEAR in $YEARS; do
            echo ""
            echo "------------------------------------------"
            echo "  Ann√©e ${YEAR} - verify + repair"
            echo "------------------------------------------"

            if [ "$YEAR" -eq 2005 ]; then
              START="${YEAR}-04-27"
            else
              START="${YEAR}-01-01"
            fi

            if [ "$YEAR" -eq 2025 ]; then
              END="2025-11-11"
            else
              END="${YEAR}-12-31"
            fi

            echo "P√©riode: ${START} ‚Üí ${END}"

            if python verify_and_repair.py \
              --start-date "$START" \
              --end-date "$END" \
              --max-passes 2 \
              --report-file "verification_report_${YEAR}.txt"
            then
              echo "‚úÖ Ann√©e ${YEAR} OK apr√®s r√©paration."
            else
              echo "‚ùå Ann√©e ${YEAR} : il reste des probl√®mes (voir verification_report_${YEAR}.txt)."
              GLOBAL_EXIT=1
            fi
          done

          exit $GLOBAL_EXIT

      # 5) Upload des rapports en artifacts
      - name: "üìÑ Upload verification reports (group ${{ matrix.group }})"
        uses: actions/upload-artifact@v4
        with:
          name: verification-reports-${{ matrix.group }}
          path: verification_report_*.txt
          retention-days: 30

      # 6) Commit + push pour les ann√©es du groupe
      - name: "üì§ Commit & push changes for group ${{ matrix.group }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          YEARS="${{ matrix.years }}"
          BRANCH="${{ github.ref_name }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="main"
          fi

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          # Stage uniquement les ann√©es de ce groupe + leurs rapports
          for YEAR in $YEARS; do
            if [ -d "resultats-et-rapports/${YEAR}" ]; then
              git add "resultats-et-rapports/${YEAR}"
            fi
            if [ -f "verification_report_${YEAR}.txt" ]; then
              git add "verification_report_${YEAR}.txt"
            fi
          done

          if git diff --cached --quiet; then
            echo "Aucun changement √† commit pour ce groupe."
            exit 0
          fi

          # Boucle de retry pour push (conflits entre jobs parall√®les)
          for attempt in 1 2 3; do
            echo "Tentative commit/push #$attempt"

            git fetch origin "$BRANCH"

            # Rebase sur l'√©tat distant pour √©viter les non-fast-forward
            if ! git rebase "origin/${BRANCH}"; then
              echo "Rebase √©chou√©, tentative d'annulation..."
              git rebase --abort || true
            fi

            if ! git diff --cached --quiet; then
              git commit -m "Verify+repair: ${YEARS} - $(date +'%Y-%m-%d %H:%M:%S')" || true
            fi

            if git push origin "HEAD:${BRANCH}"; then
              echo "‚úÖ Push r√©ussi pour le groupe ${{ matrix.group }}."
              exit 0
            fi

            echo "‚ö†Ô∏è  Push √©chou√©, nouvelle tentative dans 10s..."
            sleep 10
          done

          echo "‚ùå √âchec du push apr√®s 3 tentatives pour le groupe ${{ matrix.group }}."
          exit 1
