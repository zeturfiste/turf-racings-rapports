name: Verify ZEturf Data (par ann√©es)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

# On doit pouvoir √©crire dans le repo pour le job d'agr√©gation
permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - group_id: 1
            years: "2005 2006 2007"
          - group_id: 2
            years: "2008 2009 2010"
          - group_id: 3
            years: "2011 2012 2013"
          - group_id: 4
            years: "2014 2015 2016"
          - group_id: 5
            years: "2017 2018 2019"
          - group_id: 6
            years: "2020 2021 2022"
          - group_id: 7
            years: "2023 2024 2025"

    env:
      YEARS: ${{ matrix.years }}
      GROUP_ID: ${{ matrix.group_id }}
      TARGET_BRANCH: ${{ github.ref_name }}

    steps:
      - name: "üìä Espace disque initial (Job ${{ matrix.group_id }})"
        run: |
          echo "=== df -h (initial) ==="
          df -h

      - name: "üßπ Nettoyage agressif AVANT clone"
        run: |
          echo "=== Nettoyage agressif AVANT clone (Job $GROUP_ID) ==="
          df -h

          echo
          echo "üßπ Suppression gros SDK/runtimes inutiles..."
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf "$ANDROID_HOME" || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /opt/hostedtoolcache || true

          echo "üßπ Caches et temporaires..."
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/* || true
          sudo rm -rf /tmp/* /var/tmp/* || true
          rm -rf ~/.cache ~/.npm ~/.yarn || true

          echo
          echo "=== Espace APR√àS CLEANUP AVANT CLONE (Job $GROUP_ID) ==="
          df -h

      - name: "üì• Sparse clone du repo (Job ${{ matrix.group_id }})"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "Ann√©es pour ce job : '$YEARS'"

          BRANCH="$TARGET_BRANCH"

          echo "Clonage partiel (filter=blob:none, --sparse) sur branche $BRANCH"
          git clone --filter=blob:none --no-checkout --depth 1 --sparse \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" .

          echo
          echo "Configuration sparse-checkout pour verify.py + ann√©es n√©cessaires..."
          PATTERNS="verify.py"
          for y in $YEARS; do
            PATTERNS="$PATTERNS resultats-et-rapports/$y"
          done

          echo "Patterns : $PATTERNS"
          git sparse-checkout init --no-cone
          git sparse-checkout set $PATTERNS

          echo
          echo "Checkout de la branche $BRANCH"
          git checkout "$BRANCH"

          echo
          echo "=== ESPACE APR√àS SPARSE CLONE (Job $GROUP_ID) ==="
          df -h
          echo
          echo "Taille du repo (Job $GROUP_ID) :"
          du -sh . || true

      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "üì¶ Install dependencies (bs4 + lxml)"
        run: |
          pip install --no-cache-dir beautifulsoup4 lxml
          pip cache purge 2>/dev/null || true

      - name: "üîç V√©rification par ann√©e (Job ${{ matrix.group_id }})"
        run: |
          set -e
          mkdir -p verify_zeturf_htmls

          echo "Ann√©es √† v√©rifier pour ce job : $YEARS"
          for YEAR in $YEARS; do
            echo
            echo "========================================"
            echo "   V√©rification ann√©e $YEAR"
            echo "========================================"
            python verify.py --year "$YEAR" --output-dir verify_zeturf_htmls
          done

      - name: "üì§ Upload rapports (Job ${{ matrix.group_id }})"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verify-reports-job-${{ matrix.group_id }}
          path: verify_zeturf_htmls
          retention-days: 14

  aggregate_reports:
    runs-on: ubuntu-latest
    needs: verify
    env:
      TARGET_BRANCH: ${{ github.ref_name }}

    steps:
      - name: "üì• Checkout minimal pour les rapports"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          BRANCH="$TARGET_BRANCH"

          echo "Sparse clone pour verify_zeturf_htmls sur $BRANCH"
          git clone --filter=blob:none --no-checkout --sparse \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" .

          git sparse-checkout init --no-cone
          # On garde d√©j√† l'existant de verify_zeturf_htmls s'il y en a
          git sparse-checkout set verify_zeturf_htmls

          git checkout "$BRANCH"

          echo "Remote origin configur√© :"
          git remote -v

      - name: "üì• T√©l√©charger tous les artifacts de v√©rification"
        uses: actions/download-artifact@v4
        with:
          path: verify_zeturf_htmls_tmp

      - name: "üìÇ Fusionner les rapports dans verify_zeturf_htmls/"
        run: |
          mkdir -p verify_zeturf_htmls
          # On copie tous les verify_*.txt dans verify_zeturf_htmls/
          find verify_zeturf_htmls_tmp -type f -name 'verify_*.txt' -exec cp {} verify_zeturf_htmls/ \;

          echo "Contenu final de verify_zeturf_htmls/"
          ls -l verify_zeturf_htmls || true

      - name: "üì§ Commit & push des rapports"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add verify_zeturf_htmls

          if git diff --cached --quiet; then
            echo "Aucun changement √† commit (verify_zeturf_htmls inchang√©)."
            exit 0
          fi

          git commit -m "Update verify reports ($(date +'%Y-%m-%d %H:%M:%S'))"

          # Push (simple, un seul job push ‚Üí pas de conflit)
          git push origin "$TARGET_BRANCH"
