name: Verify ZEturf Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write

jobs:
  verify-group:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      max-parallel: 7
      matrix:
        group: [g1, g2, g3, g4, g5, g6, g7]
        include:
          - group: g1
            years: "2005 2006 2007"
          - group: g2
            years: "2008 2009 2010"
          - group: g3
            years: "2011 2012 2013"
          - group: g4
            years: "2014 2015 2016"
          - group: g5
            years: "2017 2018 2019"
          - group: g6
            years: "2020 2021 2022"
          - group: g7
            years: "2023 2024 2025"

    steps:
      - name: "üìä Disk usage BEFORE cleanup"
        run: |
          echo "=== df -h (global) ==="
          df -h
          echo ""
          echo "=== Top 20 plus gros dossiers (racine) ==="
          sudo du -xhd1 / | sort -h | tail -n 20 || true

      - name: "üßπ Aggressive cleanup BEFORE clone"
        run: |
          echo "=== df -h AVANT CLEANUP ==="
          df -h

          echo ""
          echo "üßπ Suppression des gros SDK/runtimes inutiles..."
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf "$ANDROID_HOME" || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /opt/hostedtoolcache || true

          echo ""
          echo "üßπ Docker / caches / temporaires..."
          docker system prune -af --volumes 2>/dev/null || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/* 2>/dev/null || true
          pip cache purge 2>/dev/null || true
          rm -rf ~/.cache ~/.npm ~/.yarn 2>/dev/null || true
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo journalctl --vacuum-time=1s 2>/dev/null || true
          sudo rm -rf /var/log/* 2>/dev/null || true

          echo ""
          echo "=== df -h APR√àS CLEANUP ==="
          df -h

      - name: "üì• Sparse clone pour le groupe ${{ matrix.group }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          YEARS="${{ matrix.years }}"
          BRANCH="${{ github.ref_name }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="main"
          fi

          echo "Groupe: ${{ matrix.group }} - Ann√©es: $YEARS"
          echo "Branche: $BRANCH"

          git clone --filter=blob:none --no-checkout --sparse \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" .

          git sparse-checkout init --no-cone

          PATTERNS="verify.py"
          for Y in $YEARS; do
            PATTERNS="$PATTERNS resultats-et-rapports/${Y}"
          done

          echo "Sparse-checkout patterns: $PATTERNS"
          git sparse-checkout set $PATTERNS

          git checkout "$BRANCH"

          echo ""
          echo "=== df -h APR√àS CLONE (groupe ${{ matrix.group }}) ==="
          df -h
          echo ""
          echo "=== Taille des donn√©es pour ce groupe ==="
          for Y in $YEARS; do
            if [ -d "resultats-et-rapports/${Y}" ]; then
              du -sh "resultats-et-rapports/${Y}" || true
            else
              echo "Pas de dossier resultats-et-rapports/${Y}"
            fi
          done

      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "üì¶ Install dependencies"
        run: |
          pip install --no-cache-dir beautifulsoup4 lxml
          pip cache purge 2>/dev/null || true

      - name: "‚úÖ Run verification for years ${{ matrix.years }}"
        run: |
          set -e
          YEARS="${{ matrix.years }}"

          for YEAR in $YEARS; do
            echo "------------------------------------------"
            echo "V√©rification ann√©e ${YEAR}"
            echo "------------------------------------------"

            if [ "$YEAR" -eq 2005 ]; then
              START="2005-04-27"
            else
              START="${YEAR}-01-01"
            fi

            if [ "$YEAR" -eq 2025 ]; then
              END="2025-11-11"
            else
              END="${YEAR}-12-31"
            fi

            echo "P√©riode: ${START} ‚Üí ${END}"
            python verify.py --start-date "$START" --end-date "$END" --report-file "verification_report_${YEAR}.txt"
          done

      - name: "üìÑ Upload verification reports (group ${{ matrix.group }})"
        uses: actions/upload-artifact@v4
        with:
          name: verification-reports-${{ matrix.group }}
          path: verification_report_*.txt
          retention-days: 30

  merge-reports:
    runs-on: ubuntu-latest
    needs: verify-group

    steps:
      - name: "üì• Checkout minimal repo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          filter: "blob:none"
          sparse-checkout: |
            verification_report.txt
          sparse-checkout-cone: true

      - name: "üì• Download all per-year reports"
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: "üîó Merge per-year reports into verification_report.txt"
        run: |
          rm -f verification_report.txt

          echo "Fusion des rapports par ann√©e..."
          find reports -type f -name 'verification_report_*.txt' | sort | while read -r f; do
            echo "=== Ajout de $f ==="
            cat "$f" >> verification_report.txt
            echo "" >> verification_report.txt
          done

          echo ""
          echo "Rapport fusionn√© g√©n√©r√©:"
          ls -lh verification_report.txt

      - name: "üîê Configure git remote with GITHUB_TOKEN"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git remote -v

      - name: "üì§ Commit & push merged report"
        run: |
          if [ ! -f "verification_report.txt" ]; then
            echo "verification_report.txt introuvable, rien √† commit."
            exit 1
          fi

          git add verification_report.txt
          if git diff --cached --quiet; then
            echo "Aucun changement √† commit."
            exit 0
          fi

          git commit -m "Update verification_report (grouped verify) - $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin HEAD:${{ github.ref_name }}
