name: Re-scrape Missing Courses (configurable)

on:
  workflow_dispatch:
    inputs:
      jobs_count:
        description: "Nombre de jobs parallèles (1 à 3)."
        required: true
        default: "3"
      years_job_1:
        description: "Années pour le job 1 (ex: 2008 2011 2014)."
        required: true
        default: "2008 2011 2014 2017 2020 2023"
      years_job_2:
        description: "Années pour le job 2."
        required: false
        default: "2009 2012 2015 2018 2021 2024"
      years_job_3:
        description: "Années pour le job 3."
        required: false
        default: "2010 2013 2016 2019 2022 2025"
      max_courses:
        description: "Nombre max de courses à traiter (~approx, par job). Laisser vide = toutes."
        required: false
        default: ""

permissions:
  contents: write

jobs:
  rescrape-1:
    if: ${{ github.event.inputs.jobs_count >= '1' }}
    runs-on: ubuntu-latest
    env:
      YEARS: ${{ github.event.inputs.years_job_1 }}
      MAX_COURSES: ${{ github.event.inputs.max_courses }}

    steps:
      - name: "Enregistrer l'heure de début du job"
        run: echo "JOB_START_EPOCH=$(date +%s)" >> "$GITHUB_ENV"

      - name: "Espace disque initial et top dossiers"
        run: |
          echo "=== ESPACE DISQUE INITIAL ==="
          df -h | grep -E "Filesystem|/$"
          echo ""
          echo "=== Top 20 plus gros dossiers (racine) ==="
          sudo du -x -h / | sort -hr | head -n 20 || true

      - name: "Nettoyage dynamique avant clone"
        run: |
          echo "=== NETTOYAGE DYNAMIQUE AVANT CLONE ==="
          echo "Espace avant nettoyage:"
          df -h | grep -E "Filesystem|/$"

          CANDIDATES=(
            "/usr/local/lib/android"
            "/usr/share/dotnet"
            "/usr/local/.ghcup"
            "/usr/share/swift"
            "/opt/hostedtoolcache/CodeQL"
          )

          for path in "${CANDIDATES[@]}"; do
            if [ -d "$path" ]; then
              SIZE_BEFORE=$(sudo du -sh "$path" 2>/dev/null | cut -f1)
              echo "Suppression $path (taille: $SIZE_BEFORE)"
              sudo rm -rf "$path" || true
            fi
          done

          echo "Nettoyage caches et temporaires..."
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo journalctl --vacuum-time=1s 2>/dev/null || true
          sudo rm -rf /var/log/* 2>/dev/null || true
          rm -rf ~/.cache/pip ~/.npm ~/.yarn 2>/dev/null || true

          echo "Espace après nettoyage:"
          df -h | grep -E "Filesystem|/$"

      - name: "Sparse clone (scripts + années $YEARS)"
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          YEARS: ${{ env.YEARS }}
        run: |
          echo "=== SPARSE CLONE POUR ANNEES: $YEARS ==="
          echo "Répertoire courant: $PWD"

          rm -rf .git
          git init .

          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          git config remote.origin.promisor true
          git config remote.origin.partialCloneFilter blob:none
          git config --global safe.directory "$(pwd)"

          git sparse-checkout init --cone

          PATTERNS="rescrape_courses.py
verification_report.txt"

          for y in $YEARS; do
            PATTERNS="$PATTERNS
resultats-et-rapports/$y"
          done

          printf "%s\n" "$PATTERNS" > .git/info/sparse-checkout

          echo "Patterns sparse-checkout:"
          cat .git/info/sparse-checkout

          git fetch --depth=1 origin main
          git checkout main

          echo "Contenu du repo après sparse clone:"
          ls -R .

          echo ""
          echo "Espace disque après sparse clone:"
          df -h | grep -E "Filesystem|/$"
          echo ""
          du -sh . resultats-et-rapports/* 2>/dev/null || true

          if [ ! -f "verification_report.txt" ]; then
            echo "ERREUR: verification_report.txt est manquant."
            exit 1
          fi

      - name: "Nettoyage léger du repo"
        run: |
          echo "=== NETTOYAGE LEGER DU REPO ==="
          git gc --prune=now --quiet || true
          df -h | grep -E "Filesystem|/$"

      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "Install dependencies"
        run: |
          pip install --no-cache-dir aiohttp beautifulsoup4 lxml
          pip cache purge 2>/dev/null || true

      - name: "Re-scraping des courses (job 1)"
        run: |
          echo "=== LANCEMENT RE-SCRAPING (job 1) ==="
          echo "Années: $YEARS"

          if [ -z "$YEARS" ]; then
            echo "Aucune année spécifiée pour ce job, rien à faire."
            exit 0
          fi

          if [ -z "$MAX_COURSES" ]; then
            python rescrape_courses.py --years $YEARS
          else
            python rescrape_courses.py --years $YEARS --max-courses "$MAX_COURSES"
          fi

  rescrape-2:
    if: ${{ github.event.inputs.jobs_count >= '2' }}
    runs-on: ubuntu-latest
    env:
      YEARS: ${{ github.event.inputs.years_job_2 }}
      MAX_COURSES: ${{ github.event.inputs.max_courses }}

    steps:
      - name: "Enregistrer l'heure de début du job"
        run: echo "JOB_START_EPOCH=$(date +%s)" >> "$GITHUB_ENV"

      - name: "Espace disque initial et top dossiers"
        run: |
          echo "=== ESPACE DISQUE INITIAL ==="
          df -h | grep -E "Filesystem|/$"
          echo ""
          echo "=== Top 20 plus gros dossiers (racine) ==="
          sudo du -x -h / | sort -hr | head -n 20 || true

      - name: "Nettoyage dynamique avant clone"
        run: |
          echo "=== NETTOYAGE DYNAMIQUE AVANT CLONE ==="
          echo "Espace avant nettoyage:"
          df -h | grep -E "Filesystem|/$"

          CANDIDATES=(
            "/usr/local/lib/android"
            "/usr/share/dotnet"
            "/usr/local/.ghcup"
            "/usr/share/swift"
            "/opt/hostedtoolcache/CodeQL"
          )

          for path in "${CANDIDATES[@]}"; do
            if [ -d "$path" ]; then
              SIZE_BEFORE=$(sudo du -sh "$path" 2>/dev/null | cut -f1)
              echo "Suppression $path (taille: $SIZE_BEFORE)"
              sudo rm -rf "$path" || true
            fi
          done

          echo "Nettoyage caches et temporaires..."
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo journalctl --vacuum-time=1s 2>/dev/null || true
          sudo rm -rf /var/log/* 2>/dev/null || true
          rm -rf ~/.cache/pip ~/.npm ~/.yarn 2>/dev/null || true

          echo "Espace après nettoyage:"
          df -h | grep -E "Filesystem|/$"

      - name: "Sparse clone (scripts + années $YEARS)"
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          YEARS: ${{ env.YEARS }}
        run: |
          echo "=== SPARSE CLONE POUR ANNEES: $YEARS ==="
          echo "Répertoire courant: $PWD"

          rm -rf .git
          git init .

          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          git config remote.origin.promisor true
          git config remote.origin.partialCloneFilter blob:none
          git config --global safe.directory "$(pwd)"

          git sparse-checkout init --cone

          PATTERNS="rescrape_courses.py
verification_report.txt"

          for y in $YEARS; do
            PATTERNS="$PATTERNS
resultats-et-rapports/$y"
          done

          printf "%s\n" "$PATTERNS" > .git/info/sparse-checkout

          echo "Patterns sparse-checkout:"
          cat .git/info/sparse-checkout

          git fetch --depth=1 origin main
          git checkout main

          echo "Contenu du repo après sparse clone:"
          ls -R .

          echo ""
          echo "Espace disque après sparse clone:"
          df -h | grep -E "Filesystem|/$"
          echo ""
          du -sh . resultats-et-rapports/* 2>/dev/null || true

          if [ ! -f "verification_report.txt" ]; then
            echo "ERREUR: verification_report.txt est manquant."
            exit 1
          fi

      - name: "Nettoyage léger du repo"
        run: |
          echo "=== NETTOYAGE LEGER DU REPO ==="
          git gc --prune=now --quiet || true
          df -h | grep -E "Filesystem|/$"

      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "Install dependencies"
        run: |
          pip install --no-cache-dir aiohttp beautifulsoup4 lxml
          pip cache purge 2>/dev/null || true

      - name: "Re-scraping des courses (job 2)"
        run: |
          echo "=== LANCEMENT RE-SCRAPING (job 2) ==="
          echo "Années: $YEARS"

          if [ -z "$YEARS" ]; then
            echo "Aucune année spécifiée pour ce job, rien à faire."
            exit 0
          fi

          if [ -z "$MAX_COURSES" ]; then
            python rescrape_courses.py --years $YEARS
          else
            python rescrape_courses.py --years $YEARS --max-courses "$MAX_COURSES"
          fi

  rescrape-3:
    if: ${{ github.event.inputs.jobs_count >= '3' }}
    runs-on: ubuntu-latest
    env:
      YEARS: ${{ github.event.inputs.years_job_3 }}
      MAX_COURSES: ${{ github.event.inputs.max_courses }}

    steps:
      - name: "Enregistrer l'heure de début du job"
        run: echo "JOB_START_EPOCH=$(date +%s)" >> "$GITHUB_ENV"

      - name: "Espace disque initial et top dossiers"
        run: |
          echo "=== ESPACE DISQUE INITIAL ==="
          df -h | grep -E "Filesystem|/$"
          echo ""
          echo "=== Top 20 plus gros dossiers (racine) ==="
          sudo du -x -h / | sort -hr | head -n 20 || true

      - name: "Nettoyage dynamique avant clone"
        run: |
          echo "=== NETTOYAGE DYNAMIQUE AVANT CLONE ==="
          echo "Espace avant nettoyage:"
          df -h | grep -E "Filesystem|/$"

          CANDIDATES=(
            "/usr/local/lib/android"
            "/usr/share/dotnet"
            "/usr/local/.ghcup"
            "/usr/share/swift"
            "/opt/hostedtoolcache/CodeQL"
          )

          for path in "${CANDIDATES[@]}"; do
            if [ -d "$path" ]; then
              SIZE_BEFORE=$(sudo du -sh "$path" 2>/dev/null | cut -f1)
              echo "Suppression $path (taille: $SIZE_BEFORE)"
              sudo rm -rf "$path" || true
            fi
          done

          echo "Nettoyage caches et temporaires..."
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo journalctl --vacuum-time=1s 2>/dev/null || true
          sudo rm -rf /var/log/* 2>/dev/null || true
          rm -rf ~/.cache/pip ~/.npm ~/.yarn 2>/dev/null || true

          echo "Espace après nettoyage:"
          df -h | grep -E "Filesystem|/$"

      - name: "Sparse clone (scripts + années $YEARS)"
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          YEARS: ${{ env.YEARS }}
        run: |
          echo "=== SPARSE CLONE POUR ANNEES: $YEARS ==="
          echo "Répertoire courant: $PWD"

          rm -rf .git
          git init .

          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          git config remote.origin.promisor true
          git config remote.origin.partialCloneFilter blob:none
          git config --global safe.directory "$(pwd)"

          git sparse-checkout init --cone

          PATTERNS="rescrape_courses.py
verification_report.txt"

          for y in $YEARS; do
            PATTERNS="$PATTERNS
resultats-et-rapports/$y"
          done

          printf "%s\n" "$PATTERNS" > .git/info/sparse-checkout

          echo "Patterns sparse-checkout:"
          cat .git/info/sparse-checkout

          git fetch --depth=1 origin main
          git checkout main

          echo "Contenu du repo après sparse clone:"
          ls -R .

          echo ""
          echo "Espace disque après sparse clone:"
          df -h | grep -E "Filesystem|/$"
          echo ""
          du -sh . resultats-et-rapports/* 2>/dev/null || true

          if [ ! -f "verification_report.txt" ]; then
            echo "ERREUR: verification_report.txt est manquant."
            exit 1
          fi

      - name: "Nettoyage léger du repo"
        run: |
          echo "=== NETTOYAGE LEGER DU REPO ==="
          git gc --prune=now --quiet || true
          df -h | grep -E "Filesystem|/$"

      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "Install dependencies"
        run: |
          pip install --no-cache-dir aiohttp beautifulsoup4 lxml
          pip cache purge 2>/dev/null || true

      - name: "Re-scraping des courses (job 3)"
        run: |
          echo "=== LANCEMENT RE-SCRAPING (job 3) ==="
          echo "Années: $YEARS"

          if [ -z "$YEARS" ]; then
            echo "Aucune année spécifiée pour ce job, rien à faire."
            exit 0
          fi

          if [ -z "$MAX_COURSES" ]; then
            python rescrape_courses.py --years $YEARS
          else
            python rescrape_courses.py --years $YEARS --max-courses "$MAX_COURSES"
          fi
