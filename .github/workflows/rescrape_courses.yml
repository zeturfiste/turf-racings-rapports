name: Re-scrape Missing Courses (configurable)

on:
  workflow_dispatch:
    inputs:
      jobs_count:
        description: "Nombre de jobs parall√®les (1 √† 3)."
        required: true
        default: "3"
        type: choice
        options:
          - "1"
          - "2"
          - "3"
      years_job_1:
        description: "Ann√©es pour le job 1 (ex: \"2008 2011 2014\")."
        required: true
        default: "2008 2011 2014 2017 2020 2023"
        type: string
      years_job_2:
        description: "Ann√©es pour le job 2."
        required: false
        default: "2009 2012 2015 2018 2021 2024"
        type: string
      years_job_3:
        description: "Ann√©es pour le job 3."
        required: false
        default: "2010 2013 2016 2019 2022 2025"
        type: string
      max_courses:
        description: "Nombre max de courses √† traiter (~approx, par job). Laisser vide = toutes."
        required: false
        type: string

jobs:
  rescrape-1:
    if: ${{ github.event.inputs.jobs_count >= '1' }}
    runs-on: ubuntu-latest
    env:
      YEARS: ${{ github.event.inputs.years_job_1 }}
      MAX_COURSES: ${{ github.event.inputs.max_courses }}

    steps:
      - name: "‚è±Ô∏è Enregistrer l'heure de d√©but du job"
        run: echo "JOB_START_EPOCH=$(date +%s)" >> "$GITHUB_ENV"

      - name: "üìä Espace disque initial & top dossiers"
        run: |
          echo "=========================================="
          echo "ESPACE DISQUE INITIAL"
          echo "=========================================="
          df -h | grep -E "Filesystem|/$"
          echo ""
          echo "=== Top 20 plus gros dossiers (racine) ==="
          sudo du -x -h / | sort -hr | head -n 20 || true

      - name: "üßπ Nettoyage dynamique pr√©-checkout"
        run: |
          echo "=========================================="
          echo "NETTOYAGE DYNAMIQUE AVANT CHECKOUT"
          echo "=========================================="

          echo "=== Espace avant nettoyage ==="
          df -h | grep -E "Filesystem|/$"

          CANDIDATES=(
            "/usr/local/lib/android"
            "/usr/share/dotnet"
            "/usr/local/.ghcup"
            "/usr/share/swift"
            "/opt/hostedtoolcache/CodeQL"
          )

          for path in "${CANDIDATES[@]}"; do
            if [ -d "$path" ]; then
              SIZE_BEFORE=$(sudo du -sh "$path" 2>/dev/null | cut -f1)
              echo "üßπ Suppression $path (taille: $SIZE_BEFORE)"
              sudo rm -rf "$path" || true
            fi
          done

          echo ""
          echo "=== Nettoyage caches g√©n√©raux ==="
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo journalctl --vacuum-time=1s 2>/dev/null || true
          sudo rm -rf /var/log/* 2>/dev/null || true
          rm -rf ~/.cache/pip ~/.npm ~/.yarn 2>/dev/null || true

          echo ""
          echo "=== Espace apr√®s nettoyage pr√©-checkout ==="
          df -h | grep -E "Filesystem|/$"

      - name: "üì• Checkout (sparse)"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            rescrape_courses.py
            verification_report.txt
            resultats-et-rapports

      - name: "üíæ Espace apr√®s checkout & nettoyage repo"
        run: |
          echo "=========================================="
          echo "ESPACE APR√àS CHECKOUT"
          echo "=========================================="
          df -h | grep -E "Filesystem|/$"
          echo ""
          echo "=== Taille du repo ==="
          du -sh . 2>/dev/null || echo "N/A"
          echo ""
          echo "=== Taille .git ==="
          du -sh .git 2>/dev/null || echo "N/A"

          if [ ! -f "verification_report.txt" ]; then
            echo "‚ùå verification_report.txt est manquant !"
            echo "   Ce workflow suppose que le rapport existe d√©j√†."
            exit 1
          fi

          echo ""
          echo "=== Nettoyage l√©ger du repo ==="
          git gc --prune=now --quiet || true

      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "üì¶ Install dependencies"
        run: |
          pip install --no-cache-dir aiohttp beautifulsoup4 lxml
          pip cache purge 2>/dev/null || true

      - name: "üöÄ Re-scraping des courses (job 1)"
        run: |
          echo "=========================================="
          echo "LANCEMENT DU RE-SCRAPING (job 1, ann√©es: $YEARS)"
          echo "=========================================="

          if [ -z "$YEARS" ]; then
            echo "‚ÑπÔ∏è  Aucune ann√©e sp√©cifi√©e pour ce job, rien √† faire."
            exit 0
          fi

          if [ -z "$MAX_COURSES" ]; then
            echo "‚û°Ô∏è  Re-scraping de toutes les courses manquantes pour: $YEARS"
            python rescrape_courses.py --years $YEARS
          else
            echo "‚û°Ô∏è  Re-scraping limit√© √† ~${MAX_COURSES} courses pour: $YEARS"
            python rescrape_courses.py --years $YEARS --max-courses "$MAX_COURSES"
          fi

  rescrape-2:
    if: ${{ github.event.inputs.jobs_count >= '2' }}
    runs-on: ubuntu-latest
    env:
      YEARS: ${{ github.event.inputs.years_job_2 }}
      MAX_COURSES: ${{ github.event.inputs.max_courses }}

    steps:
      - name: "‚è±Ô∏è Enregistrer l'heure de d√©but du job"
        run: echo "JOB_START_EPOCH=$(date +%s)" >> "$GITHUB_ENV"

      - name: "üìä Espace disque initial & top dossiers"
        run: |
          echo "=========================================="
          echo "ESPACE DISQUE INITIAL"
          echo "=========================================="
          df -h | grep -E "Filesystem|/$"
          echo ""
          echo "=== Top 20 plus gros dossiers (racine) ==="
          sudo du -x -h / | sort -hr | head -n 20 || true

      - name: "üßπ Nettoyage dynamique pr√©-checkout"
        run: |
          echo "=========================================="
          echo "NETTOYAGE DYNAMIQUE AVANT CHECKOUT"
          echo "=========================================="

          echo "=== Espace avant nettoyage ==="
          df -h | grep -E "Filesystem|/$"

          CANDIDATES=(
            "/usr/local/lib/android"
            "/usr/share/dotnet"
            "/usr/local/.ghcup"
            "/usr/share/swift"
            "/opt/hostedtoolcache/CodeQL"
          )

          for path in "${CANDIDATES[@]}"; do
            if [ -d "$path" ]; then
              SIZE_BEFORE=$(sudo du -sh "$path" 2>/dev/null | cut -f1)
              echo "üßπ Suppression $path (taille: $SIZE_BEFORE)"
              sudo rm -rf "$path" || true
            fi
          done

          echo ""
          echo "=== Nettoyage caches g√©n√©raux ==="
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo journalctl --vacuum-time=1s 2>/dev/null || true
          sudo rm -rf /var/log/* 2>/dev/null || true
          rm -rf ~/.cache/pip ~/.npm ~/.yarn 2>/dev/null || true

          echo ""
          echo "=== Espace apr√®s nettoyage pr√©-checkout ==="
          df -h | grep -E "Filesystem|/$"

      - name: "üì• Checkout (sparse)"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            rescrape_courses.py
            verification_report.txt
            resultats-et-rapports

      - name: "üíæ Espace apr√®s checkout & nettoyage repo"
        run: |
          echo "=========================================="
          echo "ESPACE APR√àS CHECKOUT"
          echo "=========================================="
          df -h | grep -E "Filesystem|/$"
          echo ""
          echo "=== Taille du repo ==="
          du -sh . 2>/dev/null || echo "N/A"
          echo ""
          echo "=== Taille .git ==="
          du -sh .git 2>/dev/null || echo "N/A"

          if [ ! -f "verification_report.txt" ]; then
            echo "‚ùå verification_report.txt est manquant !"
            exit 1
          fi

          echo ""
          echo "=== Nettoyage l√©ger du repo ==="
          git gc --prune=now --quiet || true

      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "üì¶ Install dependencies"
        run: |
          pip install --no-cache-dir aiohttp beautifulsoup4 lxml
          pip cache purge 2>/dev/null || true

      - name: "üöÄ Re-scraping des courses (job 2)"
        run: |
          echo "=========================================="
          echo "LANCEMENT DU RE-SCRAPING (job 2, ann√©es: $YEARS)"
          echo "=========================================="

          if [ -z "$YEARS" ]; then
            echo "‚ÑπÔ∏è  Aucune ann√©e sp√©cifi√©e pour ce job, rien √† faire."
            exit 0
          fi

          if [ -z "$MAX_COURSES" ]; then
            echo "‚û°Ô∏è  Re-scraping de toutes les courses manquantes pour: $YEARS"
            python rescrape_courses.py --years $YEARS
          else
            echo "‚û°Ô∏è  Re-scraping limit√© √† ~${MAX_COURSES} courses pour: $YEARS"
            python rescrape_courses.py --years $YEARS --max-courses "$MAX_COURSES"
          fi

  rescrape-3:
    if: ${{ github.event.inputs.jobs_count >= '3' }}
    runs-on: ubuntu-latest
    env:
      YEARS: ${{ github.event.inputs.years_job_3 }}
      MAX_COURSES: ${{ github.event.inputs.max_courses }}

    steps:
      - name: "‚è±Ô∏è Enregistrer l'heure de d√©but du job"
        run: echo "JOB_START_EPOCH=$(date +%s)" >> "$GITHUB_ENV"

      - name: "üìä Espace disque initial & top dossiers"
        run: |
          echo "=========================================="
          echo "ESPACE DISQUE INITIAL"
          echo "=========================================="
          df -h | grep -E "Filesystem|/$"
          echo ""
          echo "=== Top 20 plus gros dossiers (racine) ==="
          sudo du -x -h / | sort -hr | head -n 20 || true

      - name: "üßπ Nettoyage dynamique pr√©-checkout"
        run: |
          echo "=========================================="
          echo "NETTOYAGE DYNAMIQUE AVANT CHECKOUT"
          echo "=========================================="

          echo "=== Espace avant nettoyage ==="
          df -h | grep -E "Filesystem|/$"

          CANDIDATES=(
            "/usr/local/lib/android"
            "/usr/share/dotnet"
            "/usr/local/.ghcup"
            "/usr/share/swift"
            "/opt/hostedtoolcache/CodeQL"
          )

          for path in "${CANDIDATES[@]}"; do
            if [ -d "$path" ]; then
              SIZE_BEFORE=$(sudo du -sh "$path" 2>/dev/null | cut -f1)
              echo "üßπ Suppression $path (taille: $SIZE_BEFORE)"
              sudo rm -rf "$path" || true
            fi
          done

          echo ""
          echo "=== Nettoyage caches g√©n√©raux ==="
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo journalctl --vacuum-time=1s 2>/dev/null || true
          sudo rm -rf /var/log/* 2>/dev/null || true
          rm -rf ~/.cache/pip ~/.npm ~/.yarn 2>/dev/null || true

          echo ""
          echo "=== Espace apr√®s nettoyage pr√©-checkout ==="
          df -h | grep -E "Filesystem|/$"

      - name: "üì• Checkout (sparse)"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            rescrape_courses.py
            verification_report.txt
            resultats-et-rapports

      - name: "üíæ Espace apr√®s checkout & nettoyage repo"
        run: |
          echo "=========================================="
          echo "ESPACE APR√àS CHECKOUT"
          echo "=========================================="
          df -h | grep -E "Filesystem|/$"
          echo ""
          echo "=== Taille du repo ==="
          du -sh . 2>/dev/null || echo "N/A"
          echo ""
          echo "=== Taille .git ==="
          du -sh .git 2>/dev/null || echo "N/A"

          if [ ! -f "verification_report.txt" ]; then
            echo "‚ùå verification_report.txt est manquant !"
            exit 1
          fi

          echo ""
          echo "=== Nettoyage l√©ger du repo ==="
          git gc --prune=now --quiet || true

      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "üì¶ Install dependencies"
        run: |
          pip install --no-cache-dir aiohttp beautifulsoup4 lxml
          pip cache purge 2>/dev/null || true

      - name: "üöÄ Re-scraping des courses (job 3)"
        run: |
          echo "=========================================="
          echo "LANCEMENT DU RE-SCRAPING (job 3, ann√©es: $YEARS)"
          echo "=========================================="

          if [ -z "$YEARS" ]; then
            echo "‚ÑπÔ∏è  Aucune ann√©e sp√©cifi√©e pour ce job, rien √† faire."
            exit 0
          fi

          if [ -z "$MAX_COURSES" ]; then
            echo "‚û°Ô∏è  Re-scraping de toutes les courses manquantes pour: $YEARS"
            python rescrape_courses.py --years $YEARS
          else
            echo "‚û°Ô∏è  Re-scraping limit√© √† ~${MAX_COURSES} courses pour: $YEARS"
            python rescrape_courses.py --years $YEARS --max-courses "$MAX_COURSES"
          fi
