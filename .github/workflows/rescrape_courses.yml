name: Re-scrape Missing Courses (par ann√©es)

on:
  workflow_dispatch:
    inputs:
      jobs_count:
        description: "Nombre de jobs parall√®les (1 √† 3)"
        required: true
        default: "3"
        type: string

      years_job_1:
        description: "Ann√©es pour le job 1 (ex: '2008 2011 2014')"
        required: false
        default: "2008 2011 2014 2017 2020 2023"
        type: string

      years_job_2:
        description: "Ann√©es pour le job 2 (ex: '2009 2012 2015')"
        required: false
        default: "2009 2012 2015 2018 2021 2024"
        type: string

      years_job_3:
        description: "Ann√©es pour le job 3 (ex: '2010 2013 2016 2019 2022 2025')"
        required: false
        default: "2010 2013 2016 2019 2022 2025"
        type: string

      max_courses:
        description: "Limite globale de courses pour ce run (optionnel, pour tests)"
        required: false
        type: string

permissions:
  contents: write   # n√©cessaire pour que les commits/push dans rescrape_courses.py fonctionnent

# ----------------------------------------------------------
# Job 1
# ----------------------------------------------------------
jobs:
  rescrape-job-1:
    name: "Job 1 (ann√©es: ${{ github.event.inputs.years_job_1 }})"
    if: ${{ github.event.inputs.jobs_count == '1' || github.event.inputs.jobs_count == '2' || github.event.inputs.jobs_count == '3' }}
    runs-on: ubuntu-latest

    env:
      YEARS: ${{ github.event.inputs.years_job_1 }}
      MAX_COURSES: ${{ github.event.inputs.max_courses }}

    steps:
      - name: "üìä Espace disque initial"
        run: |
          echo "=== ESPACE DISQUE INITIAL ==="
          df -h
          echo
          echo "Top 20 plus gros dossiers (global) :"
          sudo du -xhd1 / | sort -h | tail -n 20 || true

      - name: "üßπ Nettoyage agressif AVANT checkout"
        run: |
          echo "=== Nettoyage agressif AVANT checkout ==="
          df -h

          echo
          echo "üßπ Suppression des gros SDK / runtimes inutiles pour ce job..."
          # Android SDK (~9G)
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf "$ANDROID_HOME" || true

          # Haskell / ghcup (~6G)
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /opt/ghc || true

          # .NET (~3-4G)
          sudo rm -rf /usr/share/dotnet || true

          # Swift (~3G)
          sudo rm -rf /usr/share/swift || true

          # Toolcache (Python, CodeQL, etc.) - on laisse setup-python recr√©er si besoin
          sudo rm -rf /opt/hostedtoolcache || true

          # Caches et temporaires
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/* || true
          sudo rm -rf /tmp/* /var/tmp/* || true
          rm -rf ~/.cache ~/.npm ~/.yarn || true

          echo
          echo "=== Espace disque APR√àS cleanup AVANT checkout ==="
          df -h

      - name: "üì• Checkout repo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "üìä Espace apr√®s checkout"
        run: |
          echo "=== ESPACE DISQUE APR√àS CHECKOUT ==="
          df -h
          echo
          echo "=== Taille du repo ==="
          du -sh . || true
          if [ -d "resultats-et-rapports" ]; then
            du -sh resultats-et-rapports || true
          fi

      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "üì¶ Install dependencies (aiohttp uniquement)"
        run: |
          pip install --no-cache-dir aiohttp
          pip cache purge 2>/dev/null || true

      - name: "üíæ Espace avant scraping"
        run: |
          echo "=== ESPACE AVANT SCRAPING (Job 1) ==="
          df -h
          if [ -d "resultats-et-rapports" ]; then
            du -sh resultats-et-rapports || true
          fi

      - name: "üöÄ Re-scrape courses (Job 1)"
        run: |
          set -e

          echo "Ann√©es (input brut) pour ce job: '${YEARS}'"
          YEARS_TRIMMED=$(echo "$YEARS" | xargs || true)  # trim espaces d√©but/fin
          YEARS_CSV=$(echo "$YEARS_TRIMMED" | tr ' ' ',' | tr -s ',' | sed 's/^,//;s/,$//' || true)

          ARGS=()

          if [ -n "$YEARS_CSV" ]; then
            echo "‚Üí Ann√©es envoy√©es √† rescrape_courses.py : $YEARS_CSV"
            ARGS+=(--years "$YEARS_CSV")
          else
            echo "‚ö†Ô∏è  Aucune ann√©e sp√©cifi√©e pour ce job, rescrape_courses.py traitera toutes les ann√©es pr√©sentes dans verification_report.txt."
          fi

          if [ -n "$MAX_COURSES" ]; then
            echo "‚Üí Limite globale de courses: $MAX_COURSES"
            ARGS+=(--max-courses "$MAX_COURSES")
          fi

          echo "Commande ex√©cut√©e : python rescrape_courses.py ${ARGS[*]}"
          python rescrape_courses.py "${ARGS[@]}"

      - name: "üíæ Espace apr√®s scraping (Job 1)"
        if: always()
        run: |
          echo "=== ESPACE APR√àS SCRAPING (Job 1) ==="
          df -h
          if [ -d "resultats-et-rapports" ]; then
            du -sh resultats-et-rapports || true
          fi

  # ----------------------------------------------------------
  # Job 2
  # ----------------------------------------------------------
  rescrape-job-2:
    name: "Job 2 (ann√©es: ${{ github.event.inputs.years_job_2 }})"
    if: ${{ github.event.inputs.jobs_count == '2' || github.event.inputs.jobs_count == '3' }}
    runs-on: ubuntu-latest

    env:
      YEARS: ${{ github.event.inputs.years_job_2 }}
      MAX_COURSES: ${{ github.event.inputs.max_courses }}

    steps:
      - name: "üìä Espace disque initial"
        run: |
          echo "=== ESPACE DISQUE INITIAL ==="
          df -h
          echo
          echo "Top 20 plus gros dossiers (global) :"
          sudo du -xhd1 / | sort -h | tail -n 20 || true

      - name: "üßπ Nettoyage agressif AVANT checkout"
        run: |
          echo "=== Nettoyage agressif AVANT checkout ==="
          df -h

          echo
          echo "üßπ Suppression des gros SDK / runtimes inutiles pour ce job..."
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf "$ANDROID_HOME" || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /opt/hostedtoolcache || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/* || true
          sudo rm -rf /tmp/* /var/tmp/* || true
          rm -rf ~/.cache ~/.npm ~/.yarn || true

          echo
          echo "=== Espace disque APR√àS cleanup AVANT checkout ==="
          df -h

      - name: "üì• Checkout repo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "üìä Espace apr√®s checkout"
        run: |
          echo "=== ESPACE DISQUE APR√àS CHECKOUT ==="
          df -h
          echo
          echo "=== Taille du repo ==="
          du -sh . || true
          if [ -d "resultats-et-rapports" ]; then
            du -sh resultats-et-rapports || true
          fi

      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "üì¶ Install dependencies (aiohttp uniquement)"
        run: |
          pip install --no-cache-dir aiohttp
          pip cache purge 2>/dev/null || true

      - name: "üíæ Espace avant scraping"
        run: |
          echo "=== ESPACE AVANT SCRAPING (Job 2) ==="
          df -h
          if [ -d "resultats-et-rapports" ]; then
            du -sh resultats-et-rapports || true
          fi

      - name: "üöÄ Re-scrape courses (Job 2)"
        run: |
          set -e

          echo "Ann√©es (input brut) pour ce job: '${YEARS}'"
          YEARS_TRIMMED=$(echo "$YEARS" | xargs || true)
          YEARS_CSV=$(echo "$YEARS_TRIMMED" | tr ' ' ',' | tr -s ',' | sed 's/^,//;s/,$//' || true)

          ARGS=()

          if [ -n "$YEARS_CSV" ]; then
            echo "‚Üí Ann√©es envoy√©es √† rescrape_courses.py : $YEARS_CSV"
            ARGS+=(--years "$YEARS_CSV")
          else
            echo "‚ö†Ô∏è  Aucune ann√©e sp√©cifi√©e pour ce job, rescrape_courses.py traitera toutes les ann√©es pr√©sentes dans verification_report.txt."
          fi

          if [ -n "$MAX_COURSES" ]; then
            echo "‚Üí Limite globale de courses: $MAX_COURSES"
            ARGS+=(--max-courses "$MAX_COURSES")
          fi

          echo "Commande ex√©cut√©e : python rescrape_courses.py ${ARGS[*]}"
          python rescrape_courses.py "${ARGS[@]}"

      - name: "üíæ Espace apr√®s scraping (Job 2)"
        if: always()
        run: |
          echo "=== ESPACE APR√àS SCRAPING (Job 2) ==="
          df -h
          if [ -d "resultats-et-rapports" ]; then
            du -sh resultats-et-rapports || true
          fi

  # ----------------------------------------------------------
  # Job 3
  # ----------------------------------------------------------
  rescrape-job-3:
    name: "Job 3 (ann√©es: ${{ github.event.inputs.years_job_3 }})"
    if: ${{ github.event.inputs.jobs_count == '3' }}
    runs-on: ubuntu-latest

    env:
      YEARS: ${{ github.event.inputs.years_job_3 }}
      MAX_COURSES: ${{ github.event.inputs.max_courses }}

    steps:
      - name: "üìä Espace disque initial"
        run: |
          echo "=== ESPACE DISQUE INITIAL ==="
          df -h
          echo
          echo "Top 20 plus gros dossiers (global) :"
          sudo du -xhd1 / | sort -h | tail -n 20 || true

      - name: "üßπ Nettoyage agressif AVANT checkout"
        run: |
          echo "=== Nettoyage agressif AVANT checkout ==="
          df -h

          echo
          echo "üßπ Suppression des gros SDK / runtimes inutiles pour ce job..."
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf "$ANDROID_HOME" || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /opt/hostedtoolcache || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/* || true
          sudo rm -rf /tmp/* /var/tmp/* || true
          rm -rf ~/.cache ~/.npm ~/.yarn || true

          echo
          echo "=== Espace disque APR√àS cleanup AVANT checkout ==="
          df -h

      - name: "üì• Checkout repo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "üìä Espace apr√®s checkout"
        run: |
          echo "=== ESPACE DISQUE APR√àS CHECKOUT ==="
          df -h
          echo
          echo "=== Taille du repo ==="
          du -sh . || true
          if [ -d "resultats-et-rapports" ]; then
            du -sh resultats-et-rapports || true
          fi

      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "üì¶ Install dependencies (aiohttp uniquement)"
        run: |
          pip install --no-cache-dir aiohttp
          pip cache purge 2>/dev/null || true

      - name: "üíæ Espace avant scraping"
        run: |
          echo "=== ESPACE AVANT SCRAPING (Job 3) ==="
          df -h
          if [ -d "resultats-et-rapports" ]; then
            du -sh resultats-et-rapports || true
          fi

      - name: "üöÄ Re-scrape courses (Job 3)"
        run: |
          set -e

          echo "Ann√©es (input brut) pour ce job: '${YEARS}'"
          YEARS_TRIMMED=$(echo "$YEARS" | xargs || true)
          YEARS_CSV=$(echo "$YEARS_TRIMMED" | tr ' ' ',' | tr -s ',' | sed 's/^,//;s/,$//' || true)

          ARGS=()

          if [ -n "$YEARS_CSV" ]; then
            echo "‚Üí Ann√©es envoy√©es √† rescrape_courses.py : $YEARS_CSV"
            ARGS+=(--years "$YEARS_CSV")
          else
            echo "‚ö†Ô∏è  Aucune ann√©e sp√©cifi√©e pour ce job, rescrape_courses.py traitera toutes les ann√©es pr√©sentes dans verification_report.txt."
          fi

          if [ -n "$MAX_COURSES" ]; then
            echo "‚Üí Limite globale de courses: $MAX_COURSES"
            ARGS+=(--max-courses "$MAX_COURSES")
          fi

          echo "Commande ex√©cut√©e : python rescrape_courses.py ${ARGS[*]}"
          python rescrape_courses.py "${ARGS[@]}"

      - name: "üíæ Espace apr√®s scraping (Job 3)"
        if: always()
        run: |
          echo "=== ESPACE APR√àS SCRAPING (Job 3) ==="
          df -h
          if [ -d "resultats-et-rapports" ]; then
            du -sh resultats-et-rapports || true
          fi
